<div x-data="{
  currentForm: 'repertoire',
  resType: 'link',
  easyMDE: null,
  ...pillManagement('inst'),
  ...pillManagement('os'),
  ...pillManagement('software'),
  ...pillManagement('hardware'),
  ...pillManagement('tags'),
  init() {
    this.easyMDE = new EasyMDE({
      element: $refs.mdEditor
    });
    this.fetchTags();
    this.fetchInst();
    this.fetchOs();
    this.fetchSoftware();
    this.fetchHardware();
  },
  async submit(form) {
    $refs.submitButton.disabled = true;
    try {
      if (this.currentForm === 'repertoire') {
        if (this.selectedOs.size === 0) {
          $store.toast.notify('Must select at least one (1) Operating System option.');
          return;
        }
        if (this.selectedSoftware.size === 0) {
          $store.toast.notify('Must select at least one (1) Software option.');
          return;
        }
        const fields = {
          inst: Array.from(this.selectedInst),
          os: Array.from(this.selectedOs),
          software: Array.from(this.selectedSoftware),
          hardware: Array.from(this.selectedHardware),
          notes: this.easyMDE.value()
        }
        await createItem(form, 'repertoire', fields);
      }
      if (this.currentForm === 'resource') {
        const newTagIds = [];
        if (form.newTags.value) {
          const newTags = form.newTags.value.split(',').map(t => t.trim()).filter(Boolean);
          for (const tagName of newTags) {
            try {
              const tag = await pb.collection('tags').create({ name: tagName });
              newTagIds.push(tag.id);
            } catch(err) {
              $store.toast.notify('Failed to create one or more new tags.');
            }
          }
        }
        if (!form.link.value && !this.easyMDE.value()) {
          $store.toast.notify('Must provide either link or full text content.');
          return;
        }
        const fields = {
          tags: [...this.selectedTags, ...newTagIds]
        }
        if (!fields.tags) {
          $store.toast.notify('Must create or select at least one (1) Tag.');
          return;
        }
        if (this.resType != 'link') {
          form.link.value = '';
          fields.full_text = this.easyMDE.value();
        }
        await createItem(form, 'resources', fields);
      } 
    } catch(err) {
      $store.toast.notify(err.message);
    } finally {
      $refs.submitButton.disabled = false;
    }
  }
}">

  <h2>Submit</h2>

  <label for="submission-type">Submission Type</label>
  <select @change="currentForm = $el.value">
    <option value="repertoire">Repertoire</option>
    <option value="resource">Resource</option>
  </select>

  <p>Fields marked with * are required.</p>
  <p x-show="currentForm === 'repertoire'">If selecting "Other" in any category, include clarifying details in the Notes
    section.
  </p>

  <hr>

  <form x-show="currentForm === 'repertoire'" x-ref="repForm" @submit.prevent="submit($el)">
    <div>
      <label for="title">Title</label><span> *</span><br>
      <input type="text" name="title" required>
    </div>
    <div>
      <label for="duration">Duration</label><span> * (if variable, enter an average and provide details in
        Notes)</span><br>
      <input class="duration-input" type="text" name="duration" placeholder="m:ss" required>
    </div>
    <div>
      <label for="composer">Composer</label><span> * (if multiple, enter a primary contact and provide details in
        Notes)</span><br>
      <input type="text" name="first_name" placeholder="First name" required>
      <input type="text" name="last_name" placeholder="Last name" required>
    </div>
    <div>
      <label for="email">Email</label><span> *</span><br>
      <input type="email" name="email" required>
    </div>
    <div>
      <label>Link to All Assets</label><span> * (scores, files, etc.)</span><br>
      <input type="url" name="link" required>
    </div>
    <div>
      <label for="difficulty">Difficulty</label><span> *</span><br>
      <select name="difficulty" required>
        <option value=""></option>
        <option value="1">1 (Novice)</option>
        <option value="2">2 (Intermediate)</option>
        <option value="3">3 (Advanced)</option>
      </select>
      <em>
        <p>General Recommendations:</p>
        <ul>
          <li>1 (Novice) &mdash; No notation reading skills required, minimal rehearsal.</li>
          <li>2 (Intermediate) &mdash; Requires basic notation reading and/or rhythmic coordination, regular rehearsal.
          </li>
          <li>3 (Advanced) &mdash; Requires strong notation reading and/or rhythmic coordination, rigorous rehearsal.
          </li>
        </ul>
      </em>
    </div>
    <div>
      <label for="parts">No. of Parts</label><span> *</span><br>
      <input type="number" name="parts" min="1" required>
    </div>
    <div>
      <label>Maximum Performers (leave blank if N/A)</label><br>
      <input type="number" name="max_perf" min="1">
    </div>
    <div><label for="inst">Instrumentation (if applicable)</label></div>
    <div class="pill-container">
      <template x-for="i in inst" :key="i.id">
        <button type="button" class="pill-button" :class="{ 'inactive': !instIsSelected(i.id) }" x-text="i.name"
          @click="addInst(i.id)"></button>
      </template>
      <input type="hidden" name="inst">
    </div>
    <div><label for="os">Operating System(s)</label><span> *</span></div>
    <div class="pill-container">
      <template x-for="o in os" :key="o.id">
        <button type="button" class="pill-button" :class="{ 'inactive': !osIsSelected(o.id) }" x-text="o.name"
          @click="addOs(o.id)"></button>
      </template>
      <input type="hidden" name="os">
    </div>
    <div><label for="software">Software</label><span> *</span></div>
    <div class="pill-container">
      <template x-for="s in software" :key="s.id">
        <button type="button" class="pill-button" :class="{ 'inactive': !softwareIsSelected(s.id) }" x-text="s.name"
          @click="addSoftware(s.id)"></button>
      </template>
      <input type="hidden" name="software">
    </div>
    <div><label for="hardware">Hardware (if applicable)</label></div>
    <div class="pill-container">
      <template x-for="h in hardware" :key="h.id">
        <button type="button" class="pill-button" :class="{ 'inactive': !hardwareIsSelected(h.id) }" x-text="h.name"
          @click="addHardware(h.id)"></button>
      </template>
      <input type="hidden" name="hardware">
      <em>
        <p>Assume laptops and/or personal mobile devices are standard.</p>
      </em>
    </div>
    <div>
      <label>Visuals</label><br>
      <input type="checkbox" name="visuals">
    </div>
  </form>

  <form x-show="currentForm === 'resource'" x-ref="resForm" @submit.prevent="submit($el)">
    <div>
      <label>Title</label><span> *</span><br>
      <input type=" text" name="title" required>
    </div>
    <div>
      <label>Description</label><span> *</span><br>
      <textarea name="description" rows="10" cols="40" required></textarea>
      <em>
        <p>Provide a brief description. Full details should be included via link full text below.</p>
      </em>
    </div>
    <div>
      <label for="tags">Tags</label><span> *</span>
      <div class="pill-container">
        <template x-for="tag in tags" :key="tag.id">
          <button type="button" class="pill-button" :class="{ 'inactive': !tagsIsSelected(tag.id) }" x-text="tag.name"
            @click="addTags(tag.id); dirty = true;"></button>
        </template>
        <input type="hidden" name="tags">
      </div>
    </div>
    <div>
      <label for="newTags">Create new tags if needed</label><span> (comma separated for multiple)</span><br>
      <input type="text" name="newTags" placeholder="tag1, tag2, tag3, etc.">
    </div>
    <div>
      <label for="resourceType">Resource Type</label><br>
      <select @change="resType = $el.value">
        <option value="link">Link to external site</option>
        <option value="full">Submit full text</option>
      </select>
    </div>
    <div x-show="resType === 'link'">
      <label>Link</label><span> *</span><br>
      <input type="url" name="link" placeholder="https://example.com">
    </div>
    <input type="text" name="full_text" hidden>
  </form>

  <div x-show="currentForm === 'repertoire' || resType === 'full'">
    <label x-text="currentForm === 'repertoire' ? 'Notes' : 'Content'"></label><span> *</span><br>
    <textarea x-ref="mdEditor"></textarea>
  </div>

  <button class="big-button" type="button" x-ref="submitButton"
    @click="currentForm === 'repertoire' ? $refs.repForm.requestSubmit() : $refs.resForm.requestSubmit()">Submit</button>

</div>