<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@15.0.12/lib/marked.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/anchor@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="pocketbase.umd.js"></script>
  <script>
    const pb = new PocketBase("http://127.0.0.1:8090");

    pb.authStore.onChange(() => {
      Alpine.store('auth').update();
    });

    //

    function route(href) {
      history.pushState({}, '', href);
      loadContentFromUrl();
    }

    async function loadContentFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const page = params.get('page') || 'repertoire';
      const url = `/${page}.html`;
      try {
        const response = await fetch(url);
        const html = await response.text();
        document.getElementById("content").innerHTML = html;
        Alpine.store('route').setCurrentPage(page);
      } catch (error) {
        console.error('Error loading content:', error);
      }
    }

    window.addEventListener('popstate', loadContentFromUrl);

    //

    function collectionManagement(col) {
      return {
        expanded: false,
        items: [],
        order: '+',
        sort: 'title',
        filter: '',
        page: 1,
        perPage: col === 'repertoire' ? 20 : 5,
        totalPages: null,
        async fetchItems() {
          const list = await pb.collection(col).getList(this.page, this.perPage, this.options);
          this.totalPages = list.totalPages;
          this.items = list.items;
        },
        setFilter(newFilter) {
          this.filter = newFilter;
          this.fetchItems(col);
          Alpine.store('toast').notify(`Filter applied.`);
        },
        clearFilter() {
          this.filter = '';
          this.fetchItems(col);
          Alpine.store('toast').notify(`Filter cleared.`);
        },
        setSort(newSort) {
          if (this.sort === newSort) {
            this.order = this.order === '+' ? '-' : '+';
          } else {
            this.sort = newSort;
            this.order = '+';
          }
          this.fetchItems(col);
        },
        setPaginate(page, perPage) {
          this.page = page;
          this.perPage = perPage;
          this.fetchItems(col);
        },
        resetAll() {
          this.order = '+';
          this.sort = 'title';
          this.filter = '';
          this.page = 1;
          this.perPage = 20;
          this.fetchItems(col);
        }
      }
    }

    function pillManagement(col) {
      const Cap = capitalize(col);
      return {
        [col]: [],
        [`${col}Op`]: '~',
        [`${col}Comb`]: '&&',
        [`set${Cap}OpComb`](v) {
          this.dirty = true;
          this[`${col}Comb`] = v === '!~' ? '&&' : v;
          this[`${col}Op`] = v !== '!~' ? '~' : v;
        },
        [`selected${Cap}`]: new Set(),
        [`add${Cap}`](id) {
          const set = this[`selected${Cap}`];
          if (set.has(id)) set.delete(id);
          else set.add(id);
        },
        [`clearSelected${Cap}`]() {
          this[`selected${Cap}`].clear();
        },
        [`${col}IsSelected`](id) {
          return this[`selected${Cap}`].has(id);
        },
        [`setOne${Cap}`](id) {
          const set = this[`selected${Cap}`];
          set.clear();
          set.add(id);
          return `${col} ~ '${id}'`;
        },
        [`create${Cap}Filter`]() {
          const filters = [];
          const set = this[`selected${Cap}`];
          const op = this[`${col}Op`];
          const comb = this[`${col}Comb`];
          for (const id of set) {
            filters.push(`${col} ${op} '${id}'`);
          }
          const filterString = filters.join(` ${comb} `);
          if (filterString.length) return `(${filterString})`;
          return '';
        },
        async [`fetch${Cap}`]() {
          try {
            if (this[`${col}`].length > 0) return;
            this[`${col}`] = await pb.collection(col).getFullList({
              sort: '+name'
            });
          } catch (err) {
            Alpine.store('toast').notify(`Error fetching ${col} collection.`);
          }
        }
      }
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function decToColon(dec) {
      const minutes = Math.floor(dec);
      const seconds = Math.round((dec - minutes) * 60);
      if (seconds === 60) {
        return `${minutes+1}:00`;
      }
      return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function colonToDec(colon) {
      if (colon.includes('.')) {
        return parseFloat(colon);
      }
      if (!colon.includes(':')) {
        return parseInt(colon, 10);
      }
      const parts = colon.split(':');
      const minutes = parseInt(parts[0], 10);
      const seconds = parseInt(parts[1], 10);
      return Number((minutes + seconds / 60).toFixed(2));
    }

    function initItemPage() {
      return {
        item: null,
        async fetchItem(col) {
          const params = new URLSearchParams(window.location.search);
          const id = params.get('id');
          if (!id) return;
          this.item = await pb.collection(col).getOne(id, {
            expand: 'inst,os,software,hardware,tags'
          });
        }
      }
    }

    async function createItem(form, col, fields) {
      try {
        const partialItem = Object.fromEntries(new FormData(form));
        const item = {
          ...partialItem,
          ...fields
        };
        if (col === 'repertoire') {
          item.duration = colonToDec(item.duration);
          if (item.max_perf === '') {
            item.max_perf = 999;
          }
        }
        const record = await pb.collection(col).create(item);
        const msg = col === 'users' ? 'Registration successful.' : `${record.title} created successfully.`;
        const newPage = col === 'users' ? 'repertoire' : col;
        route(`?page=${newPage}`);
        Alpine.store('toast').notify(msg);
      } catch (err) {
        const msg = err?.response?.data?.email?.message === 'Value must be unique.' ?
          'An account with this email already exists.' : (err?.response?.data?.password?.message || err?.response
            ?.data?.passwordConfirm?.message || err.message);
        Alpine.store('toast').notify(msg);
      }
    }

    //

    document.addEventListener('alpine:init', () => {
      Alpine.store('auth', {
        user: pb.authStore.model,
        update() {
          this.user = pb.authStore.model;
        }
      });
      Alpine.store('toast', {
        message: '',
        open: false,
        _timeout: null,
        notify(message) {
          this.message = message;
          this.open = true;
          if (this._timeout) {
            clearTimeout(this._timeout);
          }
          this._timeout = setTimeout(() => {
            this.open = false;
          }, 3000);
        }
      });
      Alpine.store('route', {
        currentPage: null,
        setCurrentPage(page) {
          this.currentPage = page;
        },
        savedTag: null
      })
    });
  </script>

  <style>
    [x-cloak] {
      display: none !important;
    }

    body {
      max-width: 800px;
      margin: auto;
      padding: 10px;
    }

    header {
      position: sticky;
      top: 0;
      background-color: #fff;
    }

    img {
      width: 100%;
      max-width: 600px;
    }

    form>div {
      margin: 10px 0;
    }

    input,
    select,
    button {
      font-size: 0.75rem;
    }

    textarea {
      font-family: 'Times New Roman', Times, serif;
    }

    input[type="number"] {
      width: 6ch;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
    }

    .duration-input {
      width: 6ch;
    }

    .big-button {
      font-size: 1rem;
    }

    .pill-button {
      border: 1px solid #aaa;
      border-radius: 8px;
      padding: 0.1rem 0.3rem;
      background-color: rgb(216, 237, 255);
    }

    .pill-button.inactive {
      opacity: 0.6;
      border-color: transparent;
    }

    .pill-container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1px;
      row-gap: 2px;
    }
  </style>

  <title>Document</title>
</head>

<body x-init="loadContentFromUrl()">

  <header x-data="{
    logout() {
      pb.authStore.clear();
      $store.toast.notify('Logged out.');
    } }">

    <style>
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;

        a {
          padding: 10px;
        }

        .active {
          background-color: #eee;
        }
      }
    </style>

    <nav x-ref="nav">
      <a href="?page=repertoire" @click.prevent="route($el.href)"
        :class="$store.route.currentPage === 'repertoire' ? 'active' : ''">Repertoire</a>
      <a href="?page=resources" @click.prevent="route($el.href)"
        :class="$store.route.currentPage === 'resources' ? 'active' : ''">Resources</a>
      <a x-cloak x-show="!!$store.auth.user" href="?page=submit" @click.prevent="route($el.href)"
        :class="$store.route.currentPage === 'submit' ? 'active' : ''">Submit</a>
      <a href="?page=about" @click.prevent="route($el.href)"
        :class="$store.route.currentPage === 'about' ? 'active' : ''">About</a>
      <a x-cloak x-show="!$store.auth.user" href="?page=auth" @click.prevent="route($el.href)"
        :class="$store.route.currentPage === 'auth' ? 'active' : ''">Login/Register</a>
      <span x-cloak x-show="!!$store.auth.user" x-text="$store.auth.user?.email"></span>
      <button x-cloak x-show="!!$store.auth.user" @click="logout">Logout</a>
    </nav>

    <style>
      .toast {
        background-color: #fff;
        padding: 20px;
        box-shadow: rgba(150, 150, 150, 0.2) 0px 8px 24px;
      }
    </style>

    <div x-cloak x-transition x-show="$store.toast.open" x-text="$store.toast.message"
      x-anchor.bottom.offset.20="$refs.nav" class="toast"></div>

    <hr>

  </header>

  <main id="content"></main>

</body>

</html>